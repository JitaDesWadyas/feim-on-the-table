<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FEIMÂ â€“Â CharacterÂ Sheet</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
:root{
  --amber:#ffb84d;
  --bg:#1a1a1a;
  --fg:#f5f3ef;
  --panel:#2a2a2a;
  --border:#444;
}
body{font-family:sans-serif;background:var(--bg);color:var(--fg);max-width:680px;margin:auto;padding:1rem}
h1,h2{color:var(--amber);border-bottom:1px solid #555;padding-bottom:.2rem;margin-top:1.5rem}
input,button,select,textarea{background:var(--panel);color:var(--fg);border:1px solid var(--border);padding:.6rem}
input[type=number],input[type=text],textarea,select{width:100%;box-sizing:border-box;margin-top:.3rem}
button{cursor:pointer}
.rem{background:none;border:none;color:var(--amber);font-size:1rem}
.row2 .descr{font-size:.85rem;color:#ccc}
.slot-btn{background:#333;border:1px solid var(--border);color:var(--amber);touch-action:none}

/* Actions section styling */
.action-list{padding:.6rem;display:flex;flex-direction:column;gap:.5rem}
.action-item{padding:.5rem;border:1px solid var(--border);border-radius:4px}
.action-item > .title{display:flex;justify-content:space-between;align-items:center}
.action-item > .details{display:none;padding-top:.4rem;font-size:.85rem;color:#ccc}
.btn-nav{background:none;border:none;color:var(--amber);font-size:1.2rem;cursor:pointer;padding:0 .5rem}
@media (max-width:480px){
  body{padding:.6rem}
}
</style>
</head>
<body>
<nav>
  <a href="index.html">Home</a>
  <a href="progression.html">Progression</a>
  <a href="combat_rules.html">Combat</a>
  <a href="general_rules.html">Rules</a>
  <a href="lists.html">Lists</a>
  <a href="character_sheet.html">Sheet</a>
  <a href="dungeon_master.html">Dungeon Master</a>
</nav>

<h1>FEIMÂ CharacterÂ Sheet</h1>
<p style="text-align:right">
  <button id="exportBtn" class="btn">Export JSON</button>
  <input id="importFile" type="file" accept=".json" style="display:none">
  <button id="importBtn" class="btn">Import JSON</button>
</p>

<h2>Statistics</h2>
<div class="stats">
  <label>STR <span id="mod_str" class="mod">(0)</span>
    <input data-key="str" class="persist" type="number" min="1" max="10" value="1">
  </label>
  <label>DEX <span id="mod_dex" class="mod">(0)</span>
    <input data-key="dex" class="persist" type="number" min="1" max="10" value="1">
  </label>
  <label>MAG <span id="mod_mag" class="mod">(0)</span>
    <input data-key="mag" class="persist" type="number" min="0" max="10" value="0">
  </label>
  <label>CON <span id="mod_con" class="mod">(0)</span>
    <input data-key="con" class="persist" type="number" min="1" max="10" value="1">
  </label>
  <label>END <span id="mod_end" class="mod">(0)</span>
    <input data-key="end" class="persist" type="number" min="1" max="10" value="1">
  </label>
  <label>WIS <span id="mod_wis" class="mod">(0)</span>
    <input data-key="wis" class="persist" type="number" min="0" max="10" value="0">
  </label>
</div>

<h2>Equipment</h2>
<select id="equip_weapon" class="btn"></select>
<select id="equip_head" class="btn"></select>
<select id="equip_chest" class="btn"></select>
<select id="equip_legs" class="btn"></select>

<h2>Skills</h2>
<table id="tbl_skills"><tbody></tbody></table>
<button id="addSkill" class="btn">+Â Skill</button>

<h2>Spells</h2>
<table id="tbl_spells"><tbody></tbody></table>
<button id="addSpell" class="btn">+Â Spell</button>

<h2>Inventory</h2>
<table id="tbl_inv"><tbody></tbody></table>
<button id="addItem" class="btn">+Â Item</button>

<h2>Diary</h2>
<textarea data-key="diary" class="persist" rows="5"></textarea>

<h2>Inâ€‘Game</h2>
<div class="slider-wrap">
  <button data-slider="hp" class="dec">âˆ’</button>
  <input data-key="hp" class="bar" type="range" min="0" max="10" value="10">
  <span>10</span>
  <button data-slider="hp" class="inc">+</button>
</div>
<div class="slider-wrap">
  <button data-slider="stamina" class="dec">âˆ’</button>
  <input data-key="stamina" class="bar" type="range" min="0" max="10" value="10">
  <span>10</span>
  <button data-slider="stamina" class="inc">+</button>
</div>
<div class="slider-wrap">
  <button data-slider="mana" class="dec">âˆ’</button>
  <input data-key="mana" class="bar" type="range" min="0" max="10" value="0">
  <span>0</span>
  <button data-slider="mana" class="inc">+</button>
</div>
<div class="slider-wrap">
  <button data-slider="time" class="dec">âˆ’</button>
  <input data-key="time" class="bar" type="range" min="0" max="10" value="10">
  <span>10</span>
  <button data-slider="time" class="inc">+</button>
</div>
<button id="endRound" class="btn">End Round</button>

  <h2>Actions</h2>
  <details open>
    <summary>Base Actions</summary>
    <div id="baseActions" class="action-list"></div>
  </details>

  <details open>
    <summary>Basic Skills</summary>
    <div id="basicSkills" class="action-list"></div>
  </details>

  <details>
    <summary>
      Advanced Skills
      <button id="advPrev" class="btn-nav">â—€</button>
      <button id="advNext" class="btn-nav">â–¶</button>
    </summary>
    <div id="advSkills" class="action-list"></div>
  </details>

  <details>
    <summary>
      Spells
      <button id="spellPrev" class="btn-nav">â—€</button>
      <button id="spellNext" class="btn-nav">â–¶</button>
    </summary>
    <div id="spellList" class="action-list"></div>
  </details>

<footer>Â©Â 2025Â JitaDesWadyas</footer>

<!-- Picker -->
<div id="picker">
  <input id="pickerSearch" placeholder="Type to filter">
  <ul id="pickerList"></ul>
  <button id="pickerCancel" class="btn">Cancel</button>
</div>

<script>
const q=s=>document.querySelector(s), qq=s=>document.querySelectorAll(s);
let FEIM={}, mySkills=[], mySpells=[], myInv=[];

/* ---------- JSON load ---------- */
fetch('gamedata.json').then(r=>r.json()).then(d=>{FEIM=d;initPage(); initActions();});

/* ---------- persistence primitives ---------- */
function persistInit(){
  qq('.persist').forEach(el=>{
    const key=el.getAttribute('data-key');
    if(!key) return;
    const val=localStorage['feim_'+key];
    if(val!==undefined) el.value=val;
    el.oninput=() => {
      localStorage['feim_'+key]=el.value;
      updateDisplay(); updateMods();
    };
  });
}

/* ---------- display & mods ---------- */
function updateDisplay(){
  qq('.bar').forEach(sl=>{
    const v=+sl.value;
    sl.nextElementSibling.textContent=v;
  });
}
function updateMods(){
  ['str','dex','mag','con','end','wis'].forEach(stat=>{
    const el=q('[data-key="'+stat+'"]');
    const mod=Math.floor((+el.value-1)/2);
    q('#mod_'+stat).textContent='('+mod+')';
  });
}

/* ---------- slider buttons ---------- */
function sliderButtons(){
  qq('.dec').forEach(b=>b.onclick=_=>{
    const k=b.dataset.slider, sl=q('input[data-key="'+k+'"]');
    sl.value=Math.max(0,+sl.value-1);
    updateDisplay();
  });
  qq('.inc').forEach(b=>b.onclick=_=>{
    const k=b.dataset.slider, sl=q('input[data-key="'+k+'"]');
    sl.value=Math.min(+sl.max,+sl.value-0+1);
    updateDisplay();
  });
}

/* ---------- stats / caps ---------- */
function updateCaps(){
  // HP cap = CONÃ—2, STA cap=ENDÃ—2, TIME cap=DEXÃ—2
  const caps = {
    hp: +q('[data-key="con"]').value * 2,
    stamina: +q('[data-key="end"]').value * 2,
    mana: +q('[data-key="wis"]').value * 0.5,
    time: +q('[data-key="dex"]').value * 2
  };
  Object.keys(caps).forEach(k=>{
    const sl=q('input[data-key="'+k+'"]');
    sl.max=caps[k];
    if(+sl.value>caps[k]) sl.value=caps[k];
  });
}

/* ---------- picker ---------- */
function openPicker(target){
  const box=q('#picker'), list=q('#pickerList'), inp=q('#pickerSearch');
  const data=target==='tbl_skills'?FEIM.skills
               :target==='tbl_spells'?FEIM.spells
               :[...FEIM.weapons,...FEIM.armors,...FEIM.items];
  box.style.display='flex'; inp.value='';
  render(target,'');
  inp.oninput=e=>render(target,e.target.value.toLowerCase());
  list.onclick=e=>{
    const li=e.target.closest('li'); if(!li) return;
    const obj=data.find(x=>x.id===li.dataset.id);
    if(obj){ addRow(target,obj); close(); }
  };
  q('#pickerCancel').onclick=close;
  document.onkeydown=ev=>ev.key==='Escape'&&close();
  function render(t,f){
    list.innerHTML=data
      .filter(o=>o.name.toLowerCase().includes(f))
      .map(o=>`<li data-id="${o.id}">${o.name}</li>`).join('');
  }
  function close(){ box.style.display='none'; inp.oninput=null; list.onclick=null; q('#pickerCancel').onclick=null; document.onkeydown=null; }
}

/* ---------- add/remove row ---------- */
function addRow(tableSel,obj){
  const sel='#'+tableSel, tb=q(sel+' tbody');
  const html=`<tr class="row1"><td>${obj.name}</td><td class="cost">${costString(obj)}</td><td><button class="rem" data-id="${obj.id}" data-cat="${obj.category}">ðŸ—‘</button></td></tr>
              <tr class="row2"><td colspan="3" class="descr">${desc(obj)}</td></tr>`;
  tb.insertAdjacentHTML('beforeend',html);
  if(obj.category=='skill' && !mySkills.find(x=>x.id===obj.id)) mySkills.push(obj);
  else if(obj.category=='spell' && !mySpells.find(x=>x.id===obj.id)) mySpells.push(obj);
  else if(!myInv.find(x=>x.id===obj.id)) myInv.push(obj);
  saveArrays(); rebuildTablesFromArrays(); refreshEquipSelects(); updateCaps(); updateDisplay(); updateMods(); rebuildSlots();
}

/* ---------- tables from arrays ---------- */
function rebuildTablesFromArrays(){
  ['#tbl_skills','#tbl_spells','#tbl_inv'].forEach(sel=>q(sel+' tbody').innerHTML='');
  mySkills.forEach(o=>addRow('tbl_skills',o));
  mySpells.forEach(o=>addRow('tbl_spells',o));
  myInv   .forEach(o=>addRow('tbl_inv',o));
}

/* ---------- equip selects ---------- */
function refreshEquipSelects(){
  const invIds=new Set(myInv.map(i=>i.id));
  const opt=o=>`<option value="${o.id}">${o.name}</option>`;
  q('#equip_weapon').innerHTML='<option value="">Weapon</option>'+FEIM.weapons.filter(w=>invIds.has(w.id)).map(opt).join('');
  q('#equip_head').innerHTML  ='<option value="">Head</option>'  +FEIM.armors.filter(a=>a.slot=='head'  && invIds.has(a.id)).map(opt).join('');
  q('#equip_chest').innerHTML ='<option value="">Chest</option>' +FEIM.armors.filter(a=>a.slot=='chest' && invIds.has(a.id)).map(opt).join('');
  q('#equip_legs').innerHTML  ='<option value="">Legs</option>'  +FEIM.armors.filter(a=>a.slot=='legs'  && invIds.has(a.id)).map(opt).join('');
}

/* ---------- cost & desc utils ---------- */
function costString(o){
  if(o.category=='skill'||o.category=='spell') return (o.time||2)+'s / '+o.cost.amount+' '+(o.cost.resource=='stamina'?'STA':'MP');
  if(o.def) return o.def+'Â DEF';
  if(o.damage) return o.damage.dice;
  return '-';
}
function desc(o){
  if(o.effect) return o.effect.kind=='weapon-damage'?'Weapon dmgÃ—'+o.effect.multiplier:o.effect.kind;
  return o.notes||o.penalty||'';
}

/* ---------- persistence arrays ---------- */
function saveArrays(){
  localStorage['feim_skill_ids']=JSON.stringify(mySkills.map(s=>s.id));
  localStorage['feim_spell_ids']=JSON.stringify(mySpells.map(s=>s.id));
  localStorage['feim_inv_ids']  =JSON.stringify(myInv.map(i=>i.id));
}

/* ---------- slot-based actions ---------- */
let skillIdx=0, spellIdx=0;
function rebuildSlots(){
  // original slot rendering (if needed)
}

/* ---------- use action ---------- */
function useAction(e){
  const cat=e.target.dataset.cat, list=cat=='skill'?mySkills:mySpells;
  const idx=(cat=='skill'?skillIdx:spellIdx)+(+e.target.dataset.idx);
  const obj=list[idx]; if(!obj) return;
  const resKey=obj.cost.resource=='mana'?'mana':'stamina';
  const slRes=q('input[data-key="'+resKey+'"]'), slTime=q('input[data-key="time"]');
  if(+slRes.value<obj.cost.amount||+slTime.value<obj.time){ alert('Not enough resources'); return; }
  slRes.value=+slRes.value-obj.cost.amount;
  slTime.value=+slTime.value-obj.time;
  updateDisplay();
}

/* ---------- actions init ---------- */
function initPage(){
  persistInit(); updateCaps(); updateDisplay(); updateMods(); sliderButtons(); refreshEquipSelects(); rebuildSlots();
  ['#addSkill','#addSpell','#addItem'].forEach((b,i)=>q(b).onclick=_=>openPicker(['tbl_skills','tbl_spells','tbl_inv'][i]));
}

/* ---------- Actions rendering ---------- */
function costStr(o){
  return (o.time||2)+'s / '+o.cost.amount+' '+(o.cost.resource=='stamina'?'STA':'MP');
}
function descStr(o){
  return o.effect && o.effect.dice ? o.effect.dice + ' ' + (o.effect.kind || '')
       : o.effect && o.effect.kind ? o.effect.kind
       : '';
}

function createItem(o){
  const div = document.createElement('div');
  div.className = 'action-item';
  div.innerHTML = `<div class="title"><span>${o.name}</span><small>${costStr(o)}</small></div>` +
                  `<div class="details">${descStr(o)}</div>`;
  div.querySelector('.title').onclick = () => {
    const d = div.querySelector('.details');
    d.style.display = d.style.display === 'none' ? 'block' : 'none';
  };
  return div;
}

function initActions(){
  const baseIds = ['move','basic-strike','jump'];
  const basicIds= ['dodge','parry','grapple','shove'];
  const allSkills = FEIM.skills || [];
  const advSkills = allSkills.filter(s => !baseIds.includes(s.id) && !basicIds.includes(s.id));
  const allSpells = FEIM.spells || [];

  baseIds.forEach(id => {
    const o = allSkills.find(s => s.id === id);
    if(o) document.getElementById('baseActions').appendChild(createItem(o));
  });
  basicIds.forEach(id => {
    const o = allSkills.find(s => s.id === id);
    if(o) document.getElementById('basicSkills').appendChild(createItem(o));
  });

  let aIdx=0, spIdx=0, pageSize=6;
  function renderAdv(){
    const container = document.getElementById('advSkills'); container.innerHTML = '';
    advSkills.slice(aIdx, aIdx+pageSize).forEach(o => container.appendChild(createItem(o)));
  }
  function renderSpells(){
    const container = document.getElementById('spellList'); container.innerHTML = '';
    allSpells.slice(spIdx, spIdx+pageSize).forEach(o => container.appendChild(createItem(o)));
  }
  document.getElementById('advPrev').onclick = () => { aIdx = Math.max(0, aIdx - pageSize); renderAdv(); };
  document.getElementById('advNext').onclick = () => { aIdx = Math.min(advSkills.length - pageSize, aIdx + pageSize); renderAdv(); };
  document.getElementById('spellPrev').onclick = () => { spIdx = Math.max(0, spIdx - pageSize); renderSpells(); };
  document.getElementById('spellNext').onclick = () => { spIdx = Math.min(allSpells.length - pageSize, spIdx + pageSize); renderSpells(); };
  renderAdv(); renderSpells();
}

/* ---------- misc ---------- */
document.addEventListener('dblclick',e=>{if(e.target.closest('button'))e.preventDefault();},{passive:false});
document.addEventListener('click', e=>{
  if(!e.target.classList.contains('rem')) return;
  const btn = e.target;
  const tr  = btn.closest('tr');
  const nxt = tr.nextElementSibling;
  if(nxt) nxt.remove();
  tr.remove();
  const id  = btn.dataset.id;
  const cat = btn.dataset.cat;
  if(cat==='skill')   mySkills = mySkills.filter(o=>o.id!==id);
  else if(cat==='spell') mySpells = mySpells.filter(o=>o.id!==id);
  else                  myInv    = myInv.filter(o=>o.id!==id);
  saveArrays();
  rebuildTablesFromArrays();
  refreshEquipSelects();
  updateCaps(); updateDisplay(); updateMods();
});

</script>
</body>
</html>
