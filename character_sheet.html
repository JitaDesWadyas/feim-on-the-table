<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FEIMÂ â€“Â CharacterÂ Sheet</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
:root{--amber:#ffcc66;--bg:#1a1a1a;--fg:#f0e6d2;--panel:#2a2a2a;--border:#444;}
body{font-family:sans-serif;background:var(--bg);color:var(--fg);max-width:680px;margin:auto;padding:1rem}
h1,h2{color:var(--amber);border-bottom:1px solid #555;padding-bottom:.2rem;margin-top:1.5rem}
label{font-weight:bold;margin-top:1rem;display:block}
input,textarea,select{background:var(--panel);color:var(--fg);border:1px solid var(--border);padding:.6rem}
input[type=text],input[type=number],textarea{width:100%;box-sizing:border-box;margin-top:.3rem}
input[type=number]{max-width:90px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mod{font-size:.85rem;margin-left:4px;color:#aaa;font-weight:normal}
table{width:100%;border-collapse:collapse;margin-top:.5rem;font-size:.9rem}
th,td{border:1px solid var(--border);padding:.4rem}
th{background:#333}
.row1{font-weight:600}
.cost{text-align:right;width:34%}
.descr{font-size:.85rem;color:#ccc}
.slider-wrap{display:flex;align-items:center;gap:.5rem;margin-top:1rem}
button,.slot-btn{background:#333;border:1px solid var(--border);color:var(--amber);touch-action:none}
.slider-wrap button{width:38px;height:38px;font-size:1.2rem}
.slot-btn{width:32px;height:32px;margin-right:.4rem;font-size:1rem;padding:0}
.slider-wrap span{min-width:48px;text-align:right}
input[type=range]{flex:1;height:34px;appearance:none;background:transparent}
input[type=range]::-webkit-slider-thumb{appearance:none;width:30px;height:30px;background:var(--amber);border-radius:50%;border:none}
input[type=range]::-webkit-slider-runnable-track{height:8px;background:#555;border-radius:4px}
input[type=range]::-moz-range-thumb{width:30px;height:30px;background:var(--amber);border:none;border-radius:50%}
input[type=range]::-moz-range-track{height:8px;background:#555;border-radius:4px}
nav{margin-bottom:1rem}
nav a{margin-right:.7rem;color:var(--amber);text-decoration:none;font-weight:bold}
nav a:hover{text-decoration:underline}
.btn{padding:.45rem .7rem;border-radius:4px;margin-top:.4rem;font-size:.9rem}
footer{text-align:center;margin-top:2rem;color:#777;font-size:.8rem}
#picker{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;flex-direction:column;align-items:center;padding:1rem;z-index:1000}
#picker input{width:100%;max-width:360px;margin-bottom:.6rem}
#picker ul{max-height:60vh;overflow:auto;width:100%;max-width:360px;padding:0;margin:0;list-style:none}
#picker li{padding:.4rem .6rem;border:1px solid var(--border);margin-bottom:.4rem;cursor:pointer}
@media(max-width:480px){body{padding:.6rem}table{font-size:.8rem}}
</style>
</head>
<body>

<nav>
 <a href="index.html">Home</a>
 <a href="progression.html">Progression</a>
 <a href="combat_rules.html">Combat</a>
 <a href="general_rules.html">Rules</a>
 <a href="lists.html">Lists</a>
</nav>

<h1>FEIMÂ CharacterÂ Sheet</h1>
<p style="text-align:right">
 <button id="exportBtn" class="btn">Export JSON</button>
 <input id="importFile" type="file" accept=".json" style="display:none">
 <button id="importBtn" class="btn">Import JSON</button>
</p>

<label>Name</label><input data-key="name" class="persist" type="text">
<label>Title</label><input data-key="title" class="persist" type="text">
<label>Level <span id="pts_left" style="font-size:.9rem"></span></label>
<input data-key="level" class="persist" type="number" min="1" max="10" value="1">

<h2>Statistics</h2>
<div class="stats">
 <label>STR <span id="mod_str" class="mod">(0)</span><input data-key="str" class="persist" type="number" min="1" max="10" value="1"></label>
 <label>DEX <span id="mod_dex" class="mod">(0)</span><input data-key="dex" class="persist" type="number" min="1" max="10" value="1"></label>
 <label>MAG <span id="mod_mag" class="mod">(0)</span><input data-key="mag" class="persist" type="number" min="1" max="10" value="1"></label>
 <label>CON <span id="mod_con" class="mod">(0)</span><input data-key="con" class="persist" type="number" min="1" max="10" value="1"></label>
 <label>END <span id="mod_end" class="mod">(0)</span><input data-key="end" class="persist" type="number" min="1" max="10" value="1"></label>
 <label>WIS <span id="mod_wis" class="mod">(0)</span><input data-key="wis" class="persist" type="number" min="1" max="10" value="1"></label>
</div>

<h2>Equipment</h2>
<select id="equip_weapon" class="btn"></select>
<select id="equip_head"   class="btn"></select>
<select id="equip_chest"  class="btn"></select>
<select id="equip_legs"   class="btn"></select>

<h2>Skills</h2>
<table id="tbl_skills"><tbody></tbody></table>
<button id="addSkill" class="btn">+Â Skill</button>

<h2>Spells</h2>
<table id="tbl_spells"><tbody></tbody></table>
<button id="addSpell" class="btn">+Â Spell</button>

<h2>Inventory</h2>
<table id="tbl_inv"><tbody></tbody></table>
<button id="addItem" class="btn">+Â Item</button>

<h2>Diary</h2>
<textarea data-key="diary" class="persist" rows="5"></textarea>

<h2>Inâ€‘Game</h2>
<div class="slider-wrap"><button data-slider="hp" class="dec">âˆ’</button> HP <input data-key="hp" data-step="0.5" class="persist slider" type="range" min="0" max="50" step="0.5"><span id="hp_val"></span> <button data-slider="hp" class="inc">+</button></div>
<div class="slider-wrap"><button data-slider="stamina" class="dec">âˆ’</button> ST <input data-key="stamina" data-step="0.5" class="persist slider" type="range" min="0" max="30" step="0.5"><span id="stamina_val"></span> <button data-slider="stamina" class="inc">+</button></div>
<div class="slider-wrap"><button data-slider="mana" class="dec">âˆ’</button> MP <input data-key="mana" data-step="0.5" class="persist slider" type="range" min="0" max="30" step="0.5"><span id="mana_val"></span> <button data-slider="mana" class="inc">+</button></div>
<div class="slider-wrap"><button data-slider="time" class="dec">âˆ’</button> TIME <input data-key="time" data-step="0.5" class="persist slider" type="range" min="0" max="3" step="0.5"><span id="time_val"></span> <button data-slider="time" class="inc">+</button></div>
<button id="endRound" class="btn">End Round</button>

<h2>Actions</h2>
<div id="actionSkills"></div>
<div id="actionSpells" style="margin-top:.6rem"></div>

<footer>Â©Â 2025Â JitaDesWadyas</footer>

<div id="picker">
 <input id="pickerSearch" placeholder="Type to filter">
 <ul id="pickerList"></ul>
 <button id="pickerCancel" class="btn">Cancel</button>
</div>

<script>
const q=s=>document.querySelector(s), qq=s=>document.querySelectorAll(s);
let FEIM={}, mySkills=[], mySpells=[];

/* ---------- JSON load ---------- */
fetch('gamedata.json').then(r=>r.json()).then(d=>{FEIM=d;initPage();});

/* ---------- persistence ---------- */
function persistInit(){
 qq('.persist').forEach(el=>{
  const k='feim_'+el.dataset.key;
  if(localStorage[k]!=null) el.value=localStorage[k];
  if(el.type==='range'){const lab=q('#'+el.dataset.key+'_val');if(lab) lab.textContent=el.value;}
  el.addEventListener('input',()=>{
    localStorage[k]=el.value;
    if(el.type==='range'){const lab=q('#'+el.dataset.key+'_val');if(lab) lab.textContent=el.value;}
  });
 });
}

/* ---------- picker overlay ---------- */
/* ---------- picker overlay ---------- */
function openPicker(target){
  const box   = q('#picker');
  const list  = q('#pickerList');
  const input = q('#pickerSearch');

  const data  = target==='tbl_skills' ? FEIM.skills
              : target==='tbl_spells' ? FEIM.spells
              :                           FEIM.items;   // inventory

  box.style.display = 'flex';
  input.value = '';

  render('');

  /* ----- live filter ----- */
  input.oninput = e => render(e.target.value.toLowerCase());

  /* ----- click handler (delegation) ----- */
  list.onclick = e =>{
    const li = e.target.closest('li');
    if(!li) return;                // click fuori
    const obj = data.find(x=>x.id===li.dataset.id);
    if(obj){ addRow(target,obj); close(); }
  };

  /* ----- cancel / esc ----- */
  q('#pickerCancel').onclick = close;
  document.onkeydown = ev => { if(ev.key==='Escape') close(); };

  /* ----- helpers ----- */
  function render(filter){
    list.innerHTML = data
      .filter(o=>o.name.toLowerCase().includes(filter))
      .map(o=>`<li data-id="${o.id}">${o.name}</li>`)
      .join('');
  }
  function close(){
    box.style.display='none';
    input.oninput = list.onclick = q('#pickerCancel').onclick = document.onkeydown = null;
  }
}
function costString(o){
 if(o.category=='skill'||o.category=='spell')return(o.time||2)+'s / '+o.cost.amount+' '+(o.cost.resource=='stamina'?'STA':'MP');
 if(o.def) return o.def+'Â DEF';
 if(o.damage) return o.damage.dice;
 return '-';
}
function desc(o){
 if(o.effect) return o.effect.kind=='weapon-damage'?'Weapon dmgÃ—'+o.effect.multiplier:o.effect.kind;
 return o.notes||o.penalty||'';
}
/* ---------- inserisce riga in tabella (skill / spell / item) ---------- */
function addRow(tableSel, obj){
  /* accetta 'tbl_skills' oppure '#tbl_skills' indistintamente */
  const sel = tableSel.startsWith('#') ? tableSel : '#'+tableSel;
  const tb  = q(sel + ' tbody');
  if(!tb){ console.error('Table not found:', sel); return; }

  const html = `<tr class=row1>
                  <td>${obj.name}</td>
                  <td class=cost>${costString(obj)}</td>
                  <td><button class="slot-btn rem">ðŸ—‘</button></td>
                </tr>
                <tr class=row2>
                  <td colspan=3 class=descr>${desc(obj)}</td>
                </tr>`;

  tb.insertAdjacentHTML('beforeend', html);

  /* pulsante rimozione (elimina entrambe le righe) */
  const remBtn = tb.querySelector('tr.row1:last-of-type .rem');   // prende il bottone dellâ€™ultima riga appena creata
remBtn.onclick = function(){
    const tr = this.closest('tr');
    const nxt = tr.nextElementSibling;
    if(nxt) nxt.remove();
    tr.remove();

    if(obj.category === 'skill')  mySkills = mySkills.filter(x => x.id !== obj.id);
    if(obj.category === 'spell')  mySpells = mySpells.filter(x => x.id !== obj.id);

    rebuildActions();
  };

  /* inserisci negli array player */
  if(obj.category === 'skill'  && !mySkills.find(x=>x.id===obj.id))  mySkills.push(obj);
  if(obj.category === 'spell'  && !mySpells.find(x=>x.id===obj.id)) mySpells.push(obj);

  rebuildActions();
}

/* ---------- equipment ---------- */
function initEquip(){
 q('#equip_weapon').innerHTML='<option value="">Weapon</option>'+FEIM.weapons.map(w=>`<option value="${w.id}" title="${w.damage.dice}">${w.name}</option>`).join('');
 q('#equip_head').innerHTML ='<option value="">Head</option>'+FEIM.armors.filter(a=>a.slot=='head').map(a=>`<option value="${a.id}" title="${a.def+' DEF'}">${a.name}</option>`).join('');
 q('#equip_chest').innerHTML='<option value="">Chest</option>'+FEIM.armors.filter(a=>a.slot=='chest').map(a=>`<option value="${a.id}" title="${a.def+' DEF'}">${a.name}</option>`).join('');
 q('#equip_legs').innerHTML ='<option value="">Legs</option>'+FEIM.armors.filter(a=>a.slot=='legs').map(a=>`<option value="${a.id}" title="${a.def+' DEF'}">${a.name}</option>`).join('');
}

/* ---------- actions ---------- */
let skillIdx=0,spellIdx=0;
function slotHTML(o,i,cat){
 const cost=(o.time||2)+'s / '+o.cost.amount+(o.cost.resource=='stamina'?' STA':' MP');
 return `<div class="action-slot"><button class="slot-btn" data-cat="${cat}" data-idx="${i}">â–¶ï¸Ž</button>${o.name}<span style="flex:1"></span><small>${cost}</small></div>`;
}
function renderSlots(){
 q('#actionSkills').innerHTML=mySkills.length?mySkills.slice(skillIdx,skillIdx+4).map((o,i)=>slotHTML(o,i,'skill')).join(''):'<em>No skills selected</em>';
 q('#actionSpells').innerHTML=mySpells.length?mySpells.slice(spellIdx,spellIdx+4).map((o,i)=>slotHTML(o,i,'spell')).join(''):'<em>No spells selected</em>';
 qq('.slot-btn').forEach(b=>b.onclick=useAction);
}
function rebuildActions(){skillIdx=0;spellIdx=0;renderSlots();}
function useAction(e){
 const cat=e.target.dataset.cat;
 const list=cat=='skill'?mySkills:mySpells;
 const idx=(cat=='skill'?skillIdx:spellIdx)+(+e.target.dataset.idx);
 const obj=list[idx]; if(!obj)return;
 const resKey=obj.cost.resource=='stamina'?'stamina':'mana';
 const slRes=q(`input[data-key="${resKey}"]`),slTime=q('input[data-key="time"]');
 if(+slTime.value<obj.time){alert('Not enough TIME');return;}
 if(+slRes.value<obj.cost.amount){alert('Not enough '+resKey.toUpperCase());return;}
 setVal(slTime,+slTime.value-obj.time);setVal(slRes,+slRes.value-obj.cost.amount);
}
function navSkill(d){if(mySkills.length){skillIdx=(skillIdx+d+mySkills.length)%mySkills.length;renderSlots();}}
function navSpell(d){if(mySpells.length){spellIdx=(spellIdx+d+mySpells.length)%mySpells.length;renderSlots();}}

/* ---------- stats ---------- */
const statKeys=['str','dex','mag','con','end','wis'];
function getStat(k){return +q(`[data-key="${k}"]`).value||0;}
function statSum(){return statKeys.reduce((s,k)=>s+getStat(k),0);}
function maxStatPoints(){return 13+getStat('level')*3;}
function maxSingleStat(){return 7+Math.floor((getStat('level')-1)/2);}
function statToMod(v){if(v<=1)return-3;if(v==2)return-2;if(v==3)return-1;if(v<=5)return 0;if(v==6)return 1;if(v==7)return 2;if(v==8)return 3;if(v==9)return 4;return 5;}
function updateMods(){statKeys.forEach(k=>q('#mod_'+k).textContent=`(${statToMod(getStat(k))>=0?'+':''}${statToMod(getStat(k))})`);}
function updateDisplay(){q('#pts_left').textContent=`(${maxStatPoints()-statSum()} pts left)`;}
function capSlider(id,max){const sl=q(`input[data-key="${id}"]`);if(sl){sl.max=max;if(+sl.value>max||+sl.value===0)setVal(sl,max);}}
function updateCaps(){capSlider('hp',getStat('con')*5);capSlider('stamina',6+getStat('end'));capSlider('mana',6+getStat('wis'));}
statKeys.forEach(k=>{const el=q(`[data-key="${k}"]`);el.addEventListener('input',()=>{
 if(statSum()>maxStatPoints()||+el.value>maxSingleStat())el.value=el.dataset.prev;
 el.dataset.prev=el.value;updateDisplay();updateMods();updateCaps();
});el.dataset.prev=el.value;});
q('[data-key="level"]').addEventListener('input',()=>{updateDisplay();updateCaps();updateMods();});

/* ---------- sliders ---------- */
function setVal(sl,val){sl.value=val;sl.dispatchEvent(new Event('input'));}
function sliderButtons(){
 qq('.dec,.inc').forEach(btn=>btn.addEventListener('click',e=>{
   e.preventDefault();const sl=q(`input[data-key="${btn.dataset.slider}"]`);
   const step=+sl.dataset.step||1;setVal(sl,Math.max(sl.min,Math.min(sl.max,+sl.value+(btn.classList.contains('inc')?step:-step))));
 },{passive:false}));
}
/* ---------- end round ---------- */
q('#endRound').onclick=_=>{
 const slTime=q('input[data-key="time"]');setVal(slTime,slTime.max);
 const slSTA=q('input[data-key="stamina"]');setVal(slSTA,Math.min(slSTA.max,+slSTA.value+getStat('end')));
 const slMP=q('input[data-key="mana"]');setVal(slMP,Math.min(slMP.max,+slMP.value+Math.floor(getStat('wis')*0.5)));
};

/* ---------- export/import ---------- */
q('#exportBtn').onclick=_=>{
 const o={};Object.keys(localStorage).forEach(k=>k.startsWith('feim_')&&(o[k]=localStorage[k]));
 const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(o,null,2)],{type:'application/json'}));
 a.download='feim_sheet.json';a.click();
};
q('#importBtn').onclick=_=>q('#importFile').click();
q('#importFile').onchange=e=>{const r=new FileReader();r.onload=o=>{try{
   const d=JSON.parse(o.target.result);Object.entries(d).forEach(([k,v])=>k.startsWith('feim_')&&(localStorage[k]=v));location.reload();
 }catch(err){alert('Bad JSON');}};r.readAsText(e.target.files[0]);};

/* ---------- misc ---------- */
document.addEventListener('dblclick',e=>{if(e.target.closest('button'))e.preventDefault();},{passive:false});
document.addEventListener('keydown',e=>{if(e.key==='Escape')q('#picker').style.display='none';});

/* ---------- init page ---------- */
function initPage(){
 initEquip();
 persistInit();updateCaps();updateDisplay();updateMods();
 ['#addSkill','#addSpell','#addItem'].forEach((b,i)=>q(b).onclick=_=>openPicker(['tbl_skills','tbl_spells','tbl_inv'][i]));
 sliderButtons();renderSlots();
 q('#actionSkills').insertAdjacentHTML('beforebegin','<button class="btn" onclick="navSkill(-4)">â—€</button>Â <button class="btn" onclick="navSkill(4)">â–¶</button>');
 q('#actionSpells').insertAdjacentHTML('beforebegin','<button class="btn" onclick="navSpell(-4)">â—€</button>Â <button class="btn" onclick="navSpell(4)">â–¶</button>');
}
</script>
</body>
</html>
